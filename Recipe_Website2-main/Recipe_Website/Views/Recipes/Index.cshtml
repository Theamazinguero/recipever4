@{
    ViewData["Title"] = "Browse Recipes";
}

<section class="hero text-center">
    <h1>Browse recipes</h1>
    <p class="mt-3 mb-4 text-muted" style="max-width:650px;margin:auto;">
        Discover new ideas for breakfast, lunch, and dinner. Filter by name or ingredient.
    </p>

    <div class="d-flex justify-content-center mb-3">
        <input id="searchBox"
               class="form-control w-50 me-2"
               placeholder="Search recipes (e.g. chicken, pasta)..." />
        <button id="searchBtn" class="btn btn-peach">
            Search
        </button>
    </div>
</section>

<section class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0" id="browseHeading">Recipes</h2>
        <span class="small text-muted" id="browseSummary"></span>
    </div>

    <div id="recipesContainer" class="row g-4">
        <!-- recipe cards injected here -->
    </div>
</section>

@section Scripts {
    <script>
        const recipesApiBase = "/api/recipes";

        async function loadRecipes(search) {
            const container = document.getElementById('recipesContainer');
            const heading = document.getElementById('browseHeading');
            const summary = document.getElementById('browseSummary');
            const q = (search || "").trim();

            container.innerHTML = `
                <div class="col-12">
                    <p class="text-muted mb-0">Loading recipes…</p>
                </div>`;
            heading.textContent = q.length > 0 ? `Results for "${q}"` : "Recipes";
            summary.textContent = "";

            try {
                let url = recipesApiBase;
                // If q is not empty, add ?search=
                if (q.length > 0) {
                    url += "?search=" + encodeURIComponent(q);
                }

                const response = await fetch(url, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });

                if (!response.ok) {
                    throw new Error("Failed to load recipes");
                }

                const data = await response.json();

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <p class="text-muted mb-0">No recipes found.</p>
                        </div>`;
                    summary.textContent = "";
                    return;
                }

                summary.textContent = data.length === 1
                    ? "1 recipe found"
                    : `${data.length} recipes found`;

                container.innerHTML = "";
                data.forEach(r => {
                    const col = document.createElement('div');
                    col.className = "col-md-4";

                    const desc = (r.shortDescription ?? "").substring(0, 110);

                    col.innerHTML = `
                        <div class="soft-card h-100 d-flex flex-column">
                            <h5 class="mb-2">${r.title ?? "Untitled recipe"}</h5>
                            <p class="text-muted small flex-grow-1 mb-2">
                                ${desc}${desc.length === 110 ? "..." : ""}
                            </p>
                            <button class="btn btn-sm btn-outline-peach mt-auto"
                                    onclick="viewRecipe(${r.id})">
                                View details
                            </button>
                        </div>`;
                    container.appendChild(col);
                });
            } catch (err) {
                console.error(err);
                container.innerHTML = `
                    <div class="col-12">
                        <p class="text-danger mb-1">Failed to load recipes.</p>
                        <p class="text-muted mb-0">Please try again.</p>
                    </div>`;
                heading.textContent = "Recipes";
                summary.textContent = "";
            }
        }

        function viewRecipe(id) {
            // navigate to details page – matches RecipesPagesController.Details
            window.location.href = `/Recipes/Details/${id}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const searchBox = document.getElementById('searchBox');
            const searchBtn = document.getElementById('searchBtn');

            searchBtn.addEventListener('click', () => {
                loadRecipes(searchBox.value);
            });

            searchBox.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    loadRecipes(e.target.value);
                }
            });

            // Initial load – show all approved recipes from /api/recipes
            loadRecipes("");
        });
    </script>
}

@{
    ViewData["Title"] = "Favorites";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="fw-bold mb-1">Favorite Recipes</h1>
        <p class="text-muted mb-0">
            All the recipes you’ve saved in one place. Search, browse, and quickly jump back into cooking.
        </p>
    </div>

    <div class="text-end">
        <span class="small text-muted d-block mb-1">Search favorites</span>
        <div class="d-flex">
            <input id="favoritesSearchBox"
                   class="form-control form-control-sm me-2"
                   placeholder="Search by recipe name..." />
            <button id="favoritesSearchBtn" class="btn btn-peach btn-sm">
                Search
            </button>
        </div>
    </div>
</div>

<hr class="mb-4" />

<div class="row">
    <div class="col-12">
        <div class="soft-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2 class="h5 mb-0">My Favorites</h2>
                <button type="button"
                        class="btn btn-sm btn-outline-peach"
                        onclick="loadFavorites()">
                    Refresh
                </button>
            </div>

            <div id="favoritesContainer" class="mt-3">
                <p class="text-muted mb-0">Loading your favorite recipes…</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Uses your GET /api/recipes/favorites endpoint
        const favoritesApiBase = "/api/recipes/favorites";

        function renderTagPills(tags) {
            if (!tags || tags.length === 0) return "";

            const limited = Array.from(tags).slice(0, 4);
            const pills = limited.map(t => `
                <span class="badge rounded-pill text-bg-light border me-1 mb-1">
                    ${t}
                </span>`).join("");

            return `<div class="mt-1">${pills}</div>`;
        }

        function renderFavorites(recipes) {
            const container = document.getElementById("favoritesContainer");

            if (!recipes || recipes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <h6 class="mb-1">No favorites yet</h6>
                        <p class="text-muted mb-2">
                            Browse recipes and mark them as favorites to see them here.
                        </p>
                        <a href="/RecipesPages" class="btn btn-peach btn-sm">
                            Browse recipes
                        </a>
                    </div>`;
                return;
            }

            let html = `<div class="row g-3">`;

            recipes.forEach(r => {
                const title = r.title ?? "Untitled recipe";
                const fullDesc = r.shortDescription ?? "";
                const desc = fullDesc.substring(0, 120);
                const tags = r.tags ?? [];

                html += `
                    <div class="col-md-4">
                        <div class="soft-card h-100 d-flex flex-column">
                            <div class="mb-2">
                                <h5 class="mb-1">${title}</h5>
                                <p class="text-muted small mb-2">
                                    ${desc}${fullDesc.length > 120 ? "..." : ""}
                                </p>
                            </div>

                            ${renderTagPills(tags)}

                            <div class="mt-auto d-flex justify-content-between align-items-center pt-2">
                                <button class="btn btn-sm btn-outline-peach"
                                        onclick="goToRecipe(${r.id})">
                                    View recipe
                                </button>
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="unfavoriteRecipe(${r.id})">
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>`;
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        async function loadFavorites(searchText) {
            const container = document.getElementById("favoritesContainer");
            container.innerHTML = `<p class="text-muted mb-0">Loading your favorite recipes…</p>`;

            const token = localStorage.getItem("jwt");
            if (!token) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-danger mb-2">
                            You must be logged in to view your favorites.
                        </p>
                        <a href="/Home/Login" class="btn btn-peach btn-sm">
                            Go to login
                        </a>
                    </div>`;
                return;
            }

            try {
                let url = favoritesApiBase;
                if (searchText && searchText.trim().length > 0) {
                    const q = encodeURIComponent(searchText.trim());
                    url += `?search=${q}`;
                }

                const response = await fetch(url, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        container.innerHTML = `
                            <div class="text-center py-4">
                                <p class="text-danger mb-2">
                                    You must be logged in to view your favorites.
                                </p>
                                <a href="/Home/Login" class="btn btn-peach btn-sm">
                                    Go to login
                                </a>
                            </div>`;
                        return;
                    }
                    throw new Error("Failed to load favorites");
                }

                const data = await response.json();
                renderFavorites(data);
            } catch (err) {
                console.error(err);
                container.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-danger mb-1">Error loading favorites.</p>
                        <p class="text-muted mb-2">Please try again.</p>
                        <button class="btn btn-sm btn-outline-peach" onclick="loadFavorites()">
                            Retry
                        </button>
                    </div>`;
            }
        }

        function goToRecipe(id) {
            // Uses your RecipesPagesController details route
            window.location.href = `/RecipesPages/Details/${id}`;
        }

        async function unfavoriteRecipe(recipeId) {
            if (!confirm("Remove this recipe from your favorites?")) return;

            const token = localStorage.getItem("jwt");
            if (!token) {
                alert("You must be logged in to update favorites.");
                return;
            }

            try {
                // Uses your toggle endpoint: POST /api/recipes/{id}/favorite
                const response = await fetch(`/api/recipes/${recipeId}/favorite`, {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    alert("Could not update favorites.");
                    return;
                }

                // Reload favorites after toggling
                const searchText = document.getElementById("favoritesSearchBox").value;
                loadFavorites(searchText);
            } catch (err) {
                console.error(err);
                alert("Error communicating with the server.");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            // Initial load
            loadFavorites();

            document.getElementById("favoritesSearchBtn")
                .addEventListener("click", () => {
                    const text = document.getElementById("favoritesSearchBox").value;
                    loadFavorites(text);
                });

            document.getElementById("favoritesSearchBox")
                .addEventListener("keyup", (e) => {
                    if (e.key === "Enter") {
                        loadFavorites(e.target.value);
                    }
                });
        });
    </script>
}
